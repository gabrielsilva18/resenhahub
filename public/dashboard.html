<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard do Usu√°rio - ResenhaHub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .alert {
        z-index: 1000;
        width: 400px;
        text-align: center;
        align-items: center;
        justify-content: center;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        position: fixed;
      }

      /* Ajustar tamanho dos containers das resenhas */
      .review-container {
        min-height: 200px;
        margin-bottom: 24px;
        padding: 20px;
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }

      /* Ajuste para o conte√∫do do t√≠tulo e bot√µes */
      .review-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
      }

      /* Bot√µes de editar e excluir */
      .review-buttons {
        display: flex;
        gap: 10px;
      }

      .review-buttons button {
        padding: 8px 16px;
        font-size: 14px;
      }

      /* Ajustar o tamanho da grid para resenhas */
      #reviews-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 16px;
      }

      /* Adicionar quebra de linha para resenhas longas */
      .review-content {
        word-break: break-word;
      }
    </style>
  </head>

  <body class="bg-gray-100 font-sans leading-normal tracking-normal">
    <div class="flex flex-col h-screen">
      <!-- Navbar para mobile -->
      <header class="bg-[#FBFDFC] text-blue-600 py-4 shadow-md">
        <div class="container mx-auto px-4 flex items-center justify-between">
          <!-- Logo aumentada -->
          <img src="./img/logo.png" alt="Logo Resenhahub" class="h-20" />

          <!-- Navega√ß√£o -->
          <nav class="flex items-center space-x-4">
            <ul class="flex space-x-4 items-center">
              <li>
                <a href="/criar-resenha" class="flex items-center p-4 hover:text-blue-800">
                  <span class="text-lg">‚úçÔ∏èNova Resenha</span>
                </a>
              </li>
              <li>
                <a href="/minhas-resenhas" class="flex items-center p-4 hover:text-blue-800">
                  <span class="text-lg">üìö Minhas Resenhas</span>
                </a>
              </li>
              <li>
                <a href="#" id="ver-todas-resenhas" class="flex items-center p-4 hover:text-blue-800">
                  <span class="text-lg">üìö Ver Todas Resenhas</span>
                </a>
              </li>
              <li>
                <a href="/logout" class="ml-4 bg-red-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-red-600 transition">
                  Sair
                </a>
              </li>
            </ul>
          </nav>
        </div>
      </header>

        <!-- Conte√∫do principal -->
        <main class="container mx-auto px-4 py-8">
            <div id="dashboard-content">
                <h1 class="text-3xl font-bold mb-6">Dashboard do Usu√°rio</h1>

                <!-- Cards de estat√≠sticas -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h2 class="text-xl font-bold">Total de Resenhas</h2>
                        <p class="text-gray-600 text-4xl mt-4" id="total-reviews">0</p>
                    </div>

                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h2 class="text-xl font-bold">Livros Salvos</h2>
                        <p class="text-gray-600 text-4xl mt-4">12</p>
                    </div>

                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h2 class="text-xl font-bold">Intera√ß√µes Recentes</h2>
                        <p class="text-gray-600 text-4xl mt-4">23</p>
                    </div>
                </div>

                <!-- Resenhas Recentes -->
                <div class="mt-8">
                    <h2 class="text-2xl font-bold mb-4">Minhas resenhas</h2>
                    <div id="reviews-container" class="space-y-4"></div>
                </div>
            </div>
        </main>

        <script>
            let reviews = [];
            let allReviews = []

            document.addEventListener("DOMContentLoaded", () => {
                loadUserReviews();
                const verTodasResenhasBtn = document.getElementById("ver-todas-resenhas");
                verTodasResenhasBtn.addEventListener("click", (event) => {
                    event.preventDefault();
                    displayReviews(); // Chama a fun√ß√£o para mostrar todas as resenhas
                });
            });
            document.addEventListener("DOMContentLoaded", () => {
               
                const verTodasResenhasBtn = document.getElementById("ver-todas-resenhas");
                verTodasResenhasBtn.addEventListener("click", (event) => {
                    event.preventDefault();
                    displayAllReviews(); // Chama a fun√ß√£o para mostrar todas as resenhas
                    loadAllReviews()
                });
            });


            async function loadUserReviews() {
                try {
                    const userResponse = await fetch("/api/resenhas-usuario");
                    if (!userResponse.ok) throw new Error("Erro ao carregar resenhas do usu√°rio.");
                    
                    /*const allResponse = await fetch("/api/resenhas");
                    if (!allResponse.ok) throw new Error("Erro ao carregar todas as resenhas.");*/

                    const userReviews = await userResponse.json();
                    /*const allReviews = await allResponse.json();*/

                    reviews = [...userReviews];
                    
                    displayReviews(); // Exibe resenhas do usu√°rio logado primeiro
                    updateTotalReviews();
                } catch (error) {
                    console.error("Erro:", error);
                    document.getElementById("reviews-container").innerHTML = `
                        <p class="text-red-500">Erro ao carregar as resenhas. Por favor, tente novamente mais tarde.</p>
                    `;
                }
            }

            async function loadAllReviews() {
    try {
        const allResponse = await fetch("/api/resenhas");
        if (!allResponse.ok) throw new Error("Erro ao carregar todas as resenhas.");

        const fetchedReviews = await allResponse.json(); // Mudei o nome aqui para fetchedReviews

        allReviews = [...fetchedReviews]; // Atualize a vari√°vel global allReviews

        displayAllReviews(); // Exibe todas as resenhas
    } catch (error) {
        console.error("Erro:", error);
        document.getElementById("reviews-container").innerHTML = `
            <p class="text-red-500">Erro ao carregar as resenhas. Por favor, tente novamente mais tarde.</p>
        `;
    }
}


            function displayReviews() {
                const container = document.getElementById("reviews-container");
                if (reviews.length === 0) {
                    container.innerHTML = '<p class="text-gray-500">Voc√™ ainda n√£o tem resenhas.</p>';
                    return;
                }

                const reviewsHTML = reviews
                    .slice(0, 3)
                    .map(
                        (review) => `
                            <div class="bg-white shadow rounded-lg p-6" data-review-id="${review.id}">
                                <div class="flex justify-between items-start mb-4">
                                    <a href="/resenha/${review.id}">
                                        <h2 class="text-xl font-semibold">${review.titulo} <span class="text-sm text-gray-500">${review.dt_criacao}</span></h2>
                                    </a>
                                    <div class="space-x-2">
                                        <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded">
                                            <a href="/editar-resenha/${review.id}">Editar</a>
                                        </button>
                                        <button onclick="deleteReview(${review.id})" class="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-2 rounded">
                                            Deletar
                                        </button>
                                    </div>
                                </div>
                                <p class="text-gray-600">${review.conteudo.substring(0, 500)}...</p>
                            </div>
                        `
                    )
                    .join("");

                container.innerHTML = reviewsHTML;
            }

            function displayAllReviews() {
                const dashboardContent = document.getElementById("dashboard-content");
                const reviewsHTML = allReviews
                    .map(
                        (review) => `
                            <div class="bg-white shadow rounded-lg p-6" data-review-id="${review.id}">
                                <div class="flex justify-between items-start mb-4">
                                    <a href="/resenha/${review.id}">
                                        <h2 class="text-xl font-semibold">${review.titulo} <span class="text-sm text-gray-500">${review.dt_criacao}</span></h2>
                                    </a>
                                </div>
                                <p class="text-gray-600">${review.conteudo.substring(0, 500)}...</p>
                            </div>
                        `
                    )
                    .join("");

                dashboardContent.innerHTML = `
                    <h1 class="text-3xl font-bold mb-6">Todas as Resenhas</h1>
                    <div class="space-y-4">
                        ${reviewsHTML}
                    </div>
                `;
            }

            function updateTotalReviews() {
                const totalReviewsElement = document.getElementById("total-reviews");
                totalReviewsElement.textContent = reviews.length;
            }

            function deleteReview(id) {
                if (confirm("Tem certeza que deseja deletar esta resenha?")) {
                    fetch(`/api/resenha/${id}`, { method: "DELETE" })
                        .then((response) => {
                            if (!response.ok) throw new Error("Erro ao deletar resenha.");
                            reviews = reviews.filter((review) => review.id !== id);
                            displayReviews();
                            updateTotalReviews();
                        })
                        .catch((error) => {
                            console.error("Erro:", error);
                            alert("Erro ao deletar a resenha. Tente novamente mais tarde.");
                        });
                }
            }
        </script>
    </div>
</body>
</html>