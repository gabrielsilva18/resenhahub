<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes da Resenha</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <article class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 id="titulo" class="text-3xl font-semibold mb-4"></h2>
        <p id="data" class="text-gray-500 text-sm mb-6"></p>
        <p id="conteudo" class="text-lg text-gray-700 mb-6"></p>
    </article>

    <div id="comments-section" class="bg-white shadow-lg rounded-lg p-6 mt-8 border border-gray-200">
        <h3 class="text-3xl font-bold text-gray-800 mb-4">Comentários</h3>
        <div id="comments-list" class="space-y-4"></div>
    </div>

    <div class="bg-white shadow-lg rounded-lg p-6 mt-8 border border-gray-200">
        <h3 class="text-3xl font-bold text-gray-800 mb-4">Deixe um comentário</h3>
        <form id="comment-form" class="space-y-4">
            <div>
                <label for="comment" class="block text-sm font-medium text-gray-700">Comentário</label>
                <textarea id="comment" name="comment" rows="4" class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Escreva seu comentário" required></textarea>
            </div>
            <button type="submit" class="bg-indigo-600 text-white py-2 px-4 rounded hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-200">Enviar Comentário</button>
        </form>
    </div>

    <script>
        async function fetchReview() {
            const reviewId = window.location.pathname.split("/").pop();

            try {
                const response = await fetch(`/api/resenha/${reviewId}`);
                const review = await response.json();

                document.getElementById('titulo').textContent = review.titulo;
                document.getElementById('data').textContent = `Por ${review.nome_usuario} | ${review.dt_criacao}`;
                document.getElementById('conteudo').innerHTML = review.conteudo;

                fetchComments(reviewId);
            } catch (error) {
                console.error('Erro ao carregar a resenha:', error);
                document.getElementById('comments-section').innerHTML = `<p class="text-red-500">Erro ao carregar a resenha.</p>`;
            }
        }
        async function fetchComments(reviewId) {
    try {
        const response = await fetch(`/resenhas/${reviewId}/listar-comentarios`);
        
        if (!response.ok) {
            console.error('Erro ao buscar comentários:', response.statusText);
            document.getElementById('comments-list').innerHTML = `<p class="text-red-500">Erro ao carregar os comentários.</p>`;
            return;
        }

        const comentarios = await response.json();
        const userId = await getAuthenticatedUserId(); // Obtém o ID do usuário autenticado

        let commentsHTML = '';
        comentarios.forEach(comentario => {
            commentsHTML += `
                <div class="bg-gray-100 rounded-lg p-4 shadow mb-4">
                    <p class="font-semibold text-gray-700">${comentario.nome_usuario || 'Usuário Anônimo'}</p>
                    <p class="text-gray-600" id="comment-text-${comentario.id}">${comentario.texto || 'Conteúdo do comentário não disponível.'}</p>
                    <p class="text-sm text-gray-500 mt-2">Publicado em ${comentario.dt_criacao || 'Data não disponível'}</p>
            `;

            // Verifica se o ID do usuário que criou o comentário corresponde ao ID do usuário autenticado
            if (comentario.usuarioId == userId) {
                commentsHTML += `
                    <button onclick="editComment(${comentario.id})" class="bg-blue-500 text-white py-1 px-2 rounded hover:bg-blue-600 mt-2">Editar</button>
                    <button onclick="deleteComment(${comentario.id})" class="bg-red-500 text-white py-1 px-2 rounded hover:bg-red-600 mt-2">Deletar</button>
                `;
            }

            commentsHTML += `</div>`;
        });

        document.getElementById('comments-list').innerHTML = commentsHTML;

    } catch (error) {
        console.error('Erro ao carregar os comentários:', error);
        document.getElementById('comments-section').innerHTML = `<p class="text-red-500">Erro ao carregar os comentários.</p>`;
    }
}

        document.getElementById('comment-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            const texto = document.getElementById('comment').value;

            const reviewId = parseInt(window.location.pathname.split("/").pop());

            try {
                const response = await fetch('/api/comentario/criar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ texto, resenhaId: reviewId, respostaAId: null })
                });

                if (response.ok) {
                    const novoComentario = await response.json();
                    fetchComments(reviewId); // Atualiza a lista de comentários
                    document.getElementById('comment').value = '';
                } else {
                    alert('Erro ao criar comentário.');
                }
            } catch (error) {
                console.error('Erro ao enviar o comentário:', error);
                alert('Erro ao enviar o comentário.');
            }
        });

        async function editComment(id) {
            const commentTextElement = document.getElementById(`comment-text-${id}`);
            const currentText = commentTextElement.textContent;
            const newText = prompt("Editar comentário:", currentText);

            if (newText && newText !== currentText) {
                try {
                    const response = await fetch(`/api/comentario/atualizar-resposta/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ texto: newText })
                    });

                    if (response.ok) {
                        fetchComments(parseInt(window.location.pathname.split("/").pop())); // Atualiza a lista de comentários
                    } else {
                        alert('Erro ao atualizar comentário.');
                    }
                } catch (error) {
                    console.error('Erro ao atualizar o comentário:', error);
                    alert('Erro ao atualizar o comentário.');
                }
            }
        }

        async function deleteComment(id) {
            if (confirm("Você tem certeza que deseja deletar este comentário?")) {
                try {
                    const response = await fetch(`/api/comentario/deletar/${id}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        fetchComments(parseInt(window.location.pathname.split("/").pop())); // Atualiza a lista de comentários
                    } else {
                        alert('Erro ao deletar comentário.');
                    }
                } catch (error) {
                    console.error('Erro ao deletar o comentário:', error);
                    alert('Erro ao deletar o comentário.');
                }
            }
        }
        
        async function getAuthenticatedUserId() {
    const token = localStorage.getItem('jwtToken'); // Supondo que você armazena o token no localStorage
    try {
        const response = await fetch('/api/getUserId', { // Verifique se o endpoint está correto
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`, // Inclui o token no cabeçalho
            },
            body: JSON.stringify({ token })
        });

        if (response.ok) {
            const { userId } = await response.json();
            return userId; // Retorna o ID do usuário
        } else {
            const errorMessage = await response.text();
            console.error('Erro ao obter o ID do usuário:', response.statusText, errorMessage);
        }
    } catch (error) {
        console.error('Erro ao fazer a requisição:', error);
    }
    return null; // Retorna null em caso de erro
}


        window.onload = fetchReview;
    </script>
</body>
</html>
